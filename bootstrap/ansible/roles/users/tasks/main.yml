---
- name: Validate users role prerequisites (stack service account)
  ansible.builtin.assert:
    that:
      # -------------------------------------------------------------------
      # REQUIRED INPUTS
      # -------------------------------------------------------------------
      - users_stack_user_name is defined
      - users_stack_group_name is defined
      - users_stack_user_uid is defined
      - users_stack_group_gid is defined
      - users_uid_min is defined
      - users_gid_min is defined
      - users_subid_start is defined
      - users_subid_count is defined
      - users_stack_user_ssh_pubkey_regex is defined

      # -------------------------------------------------------------------
      # NAME SAFETY
      # - Must be non-empty
      # - Must not be 'root'
      # - Must be a safe Linux identifier
      # -------------------------------------------------------------------
      - (users_stack_user_name | string | length) > 0
      - (users_stack_group_name | string | length) > 0
      - (users_stack_user_name | string) != 'root'
      - (users_stack_group_name | string) != 'root'
      - (users_stack_user_name | string) is match('^[a-z_][a-z0-9_-]*$')
      - (users_stack_group_name | string) is match('^[a-z_][a-z0-9_-]*$')

      # -------------------------------------------------------------------
      # UID/GID POLICY
      # - Enforced via users_uid_min/users_gid_min (override in group_vars)
      # - Keep <60000 to avoid collisions with some systems/exports
      # -------------------------------------------------------------------
      - (users_stack_user_uid | int) >= (users_uid_min | int)
      - (users_stack_group_gid | int) >= (users_gid_min | int)
      - (users_stack_user_uid | int) < 60000
      - (users_stack_group_gid | int) < 60000

      # -------------------------------------------------------------------
      # ROOTLESS PODMAN SUBUID/SUBGID RANGE
      # - Independent of host UID/GID
      # - Defaults are widely used on RHEL-family systems
      # -------------------------------------------------------------------
      - (users_subid_start | int) >= 10000
      - (users_subid_count | int) >= 65536

      # -------------------------------------------------------------------
      # OPTIONAL: SSH PUBLIC KEY SANITY
      # If provided, it should look like ssh-ed25519/ssh-rsa/ecdsa...
      # -------------------------------------------------------------------
      - >-
        stack_user_ssh_pubkey is not defined
        or (stack_user_ssh_pubkey | string | trim | length) == 0
        or (stack_user_ssh_pubkey | string | trim) is match(users_stack_user_ssh_pubkey_regex)
    fail_msg: >-
      Users role prerequisites failed.

      What you need to provide (usually in group_vars/stack/main.yml):
      - users_stack_user_name / users_stack_group_name
      - users_stack_user_uid / users_stack_group_gid

      Policy controls (override if desired):
      - users_uid_min / users_gid_min
      - users_subid_start / users_subid_count

      Rules enforced by this role:
      - Names must be safe Linux identifiers and must not be 'root'.
      - UID/GID must be >= users_uid_min/users_gid_min and < 60000.
      - Subuid/subgid range is used for rootless Podman and must be sane.
      - If stack_user_ssh_pubkey is set, it must look like a valid SSH public key.

- name: Ensure Stack group exists
  ansible.builtin.group:
    name: "{{ users_stack_group_name }}"
    gid: "{{ users_stack_group_gid }}"
    state: present

- name: Ensure Stack user exists (rootless Podman owner)
  ansible.builtin.user:
    name: "{{ users_stack_user_name }}"
    uid: "{{ users_stack_user_uid }}"
    group: "{{ users_stack_group_name }}"
    home: "/home/{{ users_stack_user_name }}"
    create_home: true
    shell: /bin/bash
    password: "!"
    state: present

# Optional: ensure the user has a subuid/subgid range for rootless podman
# On CentOS this is usually auto-managed by shadow-utils, but this makes it explicit.
- name: Ensure /etc/subuid has an entry for stack user
  ansible.builtin.lineinfile:
    path: /etc/subuid
    regexp: "^{{ users_stack_user_name }}:"
    line: "{{ users_stack_user_name }}:{{ users_subid_start }}:{{ users_subid_count }}"
    create: true
    mode: "0644"

- name: Ensure /etc/subgid has an entry for stack user
  ansible.builtin.lineinfile:
    path: /etc/subgid
    regexp: "^{{ users_stack_user_name }}:"
    line: "{{ users_stack_user_name }}:{{ users_subid_start }}:{{ users_subid_count }}"
    create: true
    mode: "0644"

# Optional: stack user SSH access (only managed when stack_user_ssh_pubkey is provided)
- name: Ensure .ssh directory exists for stack user
  ansible.builtin.file:
    path: "/home/{{ users_stack_user_name }}/.ssh"
    state: directory
    owner: "{{ users_stack_user_name }}"
    group: "{{ users_stack_group_name }}"
    mode: "0700"

- name: Install authorized_keys for stack user
  ansible.builtin.copy:
    dest: "/home/{{ users_stack_user_name }}/.ssh/authorized_keys"
    content: "{{ stack_user_ssh_pubkey }}"
    owner: "{{ users_stack_user_name }}"
    group: "{{ users_stack_group_name }}"
    mode: "0600"
  when:
    - stack_user_ssh_pubkey is defined
    - (stack_user_ssh_pubkey | string | trim | length) > 0

# Passwordless sudo for automation user
- name: Allow stack user passwordless sudo
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ users_stack_user_name }}"
    content: "{{ users_stack_user_name }} ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"
